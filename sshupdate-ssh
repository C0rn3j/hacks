#!/usr/bin/env bash
set -e
unset SSH_AUTH_SOCK
dest="$HOME/.ssh/authorized_keys"

temp=$(mktemp ~/.ssh/authorized_keys.XXXXXX)
ssh -T _sshkeys > "$temp"
if [[ ! -s $temp ]]; then
	rm -f "$temp"
	echo "sshupdate: failed (no data received)" >&2
	exit 1
fi

exec >"$dest"

echo "# updated $(date +"%Y-%m-%d %H:%M") over SSH"
cat "$temp"
rm -f "$temp"

local="${dest}.local"
if [[ -f $local ]] && [[ -s $local ]]; then
	echo "# local keys from $local"
	cat "$local"
fi
