#!/usr/bin/env bash

have() { command -v "$1" >&/dev/null; }

filter() { perl -pe 's/\033/"^".chr(ord($&)+0100)/ge'; }

set -o pipefail

detail=0

while getopts "l" OPT; do
	case $OPT in
	'l') detail=1;;
	esac
done

shift $((OPTIND-1))
query=$1

if (( detail )); then
	query="/W $query"
fi

if [[ $query == *@* ]]; then
	host=${query##*@}
	query=${query%@*}
else
	host=localhost
fi

if [[ $host == *:* ]]; then
	uhost=[$host]
else
	uhost=$host
fi

uquery=$(urlencode -- "$query")

if have curl; then
	curl -sS "gopher://$uhost:79/0$uquery"
elif have ncat; then
	printf '%s\r\n' "$query" | ncat "$host" 79
elif have socat; then
	printf '%s\r\n' "$query" | socat -t10 -T10 stdio "tcp:$uhost:79"
elif have lynx; then
	# adds own header, footer
	lynx -dump "finger://$host/$uquery"
elif have nc; then
	# may be IPv4-only
	printf '%s\r\n' "$query" | nc "$host" 79
else
	echo "fbin/finger: No useful TCP client found." >&2
	exit 1
fi | filter
