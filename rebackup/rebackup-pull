#!/usr/bin/env bash
unset SSH_AUTH_SOCK
umask 077
if ! [[ $1 && $2 ]]; then
	echo "Usage: rebackup-pull jobname hostname"
	exit 2
fi
date=$(date -u +%Y%m%d)
jobname=$1
hostname=$2
file=~/backups/$jobname.$date.gpg
keyfile=~/.ssh/rebackup-$hostname.key

ssh -i "$keyfile" -aTx -oPreferredAuthentications=publickey "$hostname" rebackup-serve "$jobname" > "$file"
if ! [[ -s $file ]]; then
	echo "failed to pull backup from $jobname ($hostname)" >&2
	exit 1
fi
find "$(dirname "$file")" -name "$jobname.*" -type f -mtime +5 -delete
