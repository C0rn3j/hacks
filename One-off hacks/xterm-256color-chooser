#!/bin/bash

declare -i red=2 green=2 blue=2 color=4 level=10
declare -a flags=";"

toraw() {
	stty -icanon </dev/tty
	printf '\e[?25l'
}

fromraw() {
	stty icanon </dev/tty
	printf '\e[?25h'
}

-red() { (( red > 0 )) && (( --red )); }
+red() { (( red < 5 )) && (( ++red )); }

-green() { (( green > 0 )) && (( --green )); }
+green() { (( green < 5 )) && (( ++green )); }

-blue() { (( blue > 0 )) && (( --blue )); }
+blue() { (( blue < 5 )) && (( ++blue )); }

-color() { (( color > 0 )) && (( --color )); }
+color() { (( color < 15 )) && (( ++color )); }

-level() { (( level > 0 )) && (( --level )); }
+level() { (( level < 23 )) && (( ++level )); }

tflag() {
	if [[ $flags == *";$1;"* ]]; then
		flags=${flags//;$1;/;}
	else
		flags+="$1;"
	fi
}

readnum() {
	fromraw
	read -p 'number: ' num </dev/tty
	(( num < 16 || num > 231)) && return
	num=$(( num - 16 ))
	blue=$(( num % 6 ))
	num=$(( (num - blue) / 6 ))
	green=$(( num % 6 ))
	num=$(( (num - green) / 6 ))
	red=$(( num ))
	toraw
}

ansi() {
	case $mode in
	256color)
		printf '%s38;5;%d' "$flags" "$(( 16 + (red*36) + (green*6) + (blue*1) ))"
		;;
	syscolor)
		printf '%s38;5;%d' "$flags" "$(( color ))"
		;;
	grays)
		printf '%s38;5;%d' "$flags" "$(( 232 + level ))"
		;;
	esac
}

bars() {
	case $mode in
	256color)
		bar red
		bar green
		bar blue
		;;
	syscolor)
		bar color 15
		;;
	grays)
		bar level 23
		;;
	esac
}

bar() {
	declare var=$1 min=0 max=${2:-'5'}
	declare oldvalue=${!var}

	printf '%10s[' "$var: "
	for (( value = min; value <= max; value++ )); do
		declare $var=$value
		printf '\e[%sm##' "`ansi`"
	done
	printf '\e[m] %d\n' $oldvalue

	printf '%10s ' " "
	for (( value = min; value <= max; value++ )); do
		if (( value == oldvalue )); then
			printf '^^'
		else
			printf '  '
		fi
	done
	printf '\e[m\n'
}

str="Example text, example text, example text"

unset key

mode='256color'

toraw

while true; do
	if [[ $key ]]; then
		read -n 1 -s key </dev/tty
	else
		key='.'
	fi

	case $mode in
	256color)
		case $key in
		1)	-blue;;
		3)	+blue;;
		4)	-green;;
		6)	+green;;
		7)	-red;;
		9)	+red;;
		+)	+red; +green; +blue;;
		-)	-red; -green; -blue;;

		n)	readnum;;

		b)	tflag 1;;
		u)	tflag 4;;
		r)	tflag 7;;
		s)	tflag 9;;

		g)	mode=syscolor;;
		q)	break;;
		.)	unset i;;
		*)	continue;;
		esac;;
	syscolor)
		case $key in
		7|4|1|-)	-color;;
		9|6|3|+)	+color;;

		b)	tflag 1;;
		u)	tflag 4;;
		r)	tflag 7;;
		s)	tflag 9;;

		g)	mode=grays;;
		q)	break;;
		.)	unset i;;
		*)	continue;;
		esac;;
	grays)
		case $key in
		7|4|1|-)	-level;;
		9|6|3|+)	+level;;

		b)	tflag 1;;
		u)	tflag 4;;
		r)	tflag 7;;
		s)	tflag 9;;

		g)	mode=256color;;
		q)	break;;
		.)	unset i;;
		*)	continue;;
		esac;;
	esac

	printf '\e[H\e[2J\n'

	bars

	printf '%10s' "ansi: "
	printf '%s\n' "`ansi`"
	printf '\n'

	printf '  \033[%sm%s\033[m\n\n' "`ansi`" "$str"

	printf '%10s%s\n' "keys: " "red: 7/9, green: 4/6, blue: 1/3"
	printf '%10s%s\n' "" "all: +/-, format: b/r/u/s, mode: g"
done

fromraw
