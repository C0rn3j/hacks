#!/usr/bin/env bash
# Dotfile updater.
update() {
	get .bashrc "${BASE}dot/bashrc"
	get .inputrc "${BASE}dot/inputrc"
	get .profile "${BASE}dot/profile"
	get .vimrc "${BASE}dot/vimrc"
	get .vimrc.input "${BASE}dot/vimrc-input"
	get .ssh/config "${BASE}dot/ssh-config"
	#get .ssh/known_hosts "${BASE}dot/ssh-knownhosts"
	get bin/sshupdate "${BASE}code/sshupdate" u+x
}

updateself() {
	get bin/dotrc.new "${BASE}misc/dotrc.sh" u+x &&
	if [ -s bin/dotrc.new ]; then
		exec mv -f bin/dotrc.new bin/dotrc
	else
		echo "Failed to update dotrc from ${BASE}misc/dotrc.sh"
		return 1
	fi
}

have() { command -v "$@" >& /dev/null; }
log() { [ -t 0 ] && echo "$@"; }
get() {
	local file="$1" url="$2"
	log "$url -> $file"
	[[ "$file" = */* ]] && mkdir -p "$(dirname "$file")"
	getfile "$url" "$file"
	[ "$3" ] && chmod "$3" "$file"
}

if have wget; then
	getfile() { wget --ca-certificate "$CACERT" -q "$1" -O "$2"; }
elif have curl; then
	getfile() { curl -L --cacert "$CACERT" -s "$1" -o "$2"; }
else
	echo "No HTTP support!" >&2
	exit 1
fi

CACERT=~/nullroute.pem
BASE="https://wind.nullroute.eu.org/~grawity/"

cd ~ || exit 1

if ! [ -e "$CACERT" ]; then
	echo "! CA certificate not found: $CACERT" >&2
	exit 1
fi

case "$1" in
self)
	updateself;;
*)
	update; updateself;;
esac
