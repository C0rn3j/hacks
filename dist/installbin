#!/usr/bin/env bash
set -e

link() {
	local target="$dir/${1%/}" link=$2
	if [ -e "$link" ] && [ ! -h "$link" ] && ! $force; then
		echo "Not overwriting $link" >&2
	else
		rm -f "$link"
		sym -vf "$target" "$link"
	fi
}

sym() { "$dir/sym.pl" "$@"; }

have() { which "$1" >/dev/null 2>&1; }

[ "$MAKELEVEL" = "1" ] &&
	unset MAKELEVEL

dir=~/code
all=false
force=false

while getopts ad:f OPT; do
	case $OPT in
	a)	all=true;;
	d)	dir=$OPTARG;;
	f)	force=true;;
	esac
done

mkdir -p ~/bin ~/lib
mkdir -pm 0700 ~/tmp

$force && make clean

make all

link	bin/args		~/bin/args
link	bin/bgrep		~/bin/bgrep
link	getpaste.pl		~/bin/getpaste
link	gist.pl			~/bin/gist
link	rdt.php			~/bin/rdt
link	bin/silentcat		~/bin/silentcat
link	sym.pl			~/bin/sym
link	tools/urlencode		~/bin/urlencode

rm -f	~/bin/getsession

if [ -f /usr/include/krb5.h ]; then
	make pklist
	link pklist/pklist ~/bin/pklist
fi

if have python2 && ! have python; then
	ln -sf "`which python`" ~/bin/python2
fi
