#!/usr/bin/env bash
set -e

test "$MAKELEVEL" ||
	cd ~/code

# Collect OS information

test ! "$HOSTTYPE" &&
	HOSTTYPE="$(uname -m)"

test ! "$MACHTYPE" &&
	MACHTYPE="$HOSTTYPE-$OSTYPE"

test ! "$DISTTYPE" && {
	if test -e "/etc/os-release"; then
		DIST=$(. /etc/os-release && echo "$ID")
	else
		DIST="unknown"
	fi
	DISTTYPE="$HOSTTYPE-$(uname)-$DIST"
}

unset nofail

case $1 in
	"-D")	echo "$DIST"; exit;;
	"-O")	echo "$OSTYPE"; exit;;
	"-d")	echo "$DISTTYPE"; exit;;
	"-h")	echo "$HOSTTYPE"; exit;;
	"-m")	echo "$MACHTYPE"; exit;;
	"-v")	echo "ostype: $OSTYPE";
		echo "dist: $DIST";
		echo "hosttype: $HOSTTYPE";
		echo "machtype: $MACHTYPE";
		echo "disttype: $DISTTYPE";
		nofail=y;;
esac

ARCHOBJ="obj/arch.$MACHTYPE"
DISTOBJ="obj/dist.$DISTTYPE"
HOSTOBJ="obj/host.$HOSTNAME"

if test "$out"; then
	case $out in
	a|arch)	OBJDIR="$ARCHOBJ";;
	d|dist)	OBJDIR="$DISTOBJ";;
	h|host)	OBJDIR="$HOSTOBJ";;
	*)	echo "dist/prepare: invalid \$out value '$out'" >&2
		exit 1;;
	esac
else
	if test "$OBJ"; then
		OBJDIR="$OBJ"
	elif test -L "$HOSTOBJ"; then
		OBJDIR="obj/$(readlink "$HOSTOBJ")"
	elif test -d "$HOSTOBJ"; then
		OBJDIR="$HOSTOBJ"
	elif out="dist"; then
		OBJDIR="$DISTOBJ"
	fi
fi

case $1 in
	"-o")	echo "$OBJDIR"; exit;;
	"-v")	echo "obj: ${OBJDIR-?}"; exit;;
esac

if test "$out"; then
	if test -L "$HOSTOBJ"; then
		rm -f "$HOSTOBJ"
	fi

	if test "$OBJDIR" != "$HOSTOBJ"; then
		if test -d "$HOSTOBJ"; then
			echo "dist/prepare: removing $HOSTOBJ"
			rm -rf "$HOSTOBJ"
		fi
		ln -sf "${OBJDIR##*/}" "$HOSTOBJ"
	fi

	echo "dist/prepare: creating $OBJDIR"
	mkdir -p "$OBJDIR"
fi
