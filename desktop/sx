#!/bin/sh

die() { echo "error: $*" >&2; exit 1; }

# bail early if not on a VC

vt="vt$(fgconsole)" || exit

# set environment

if test -f ~/.xinitrc; then
	set -- ~/.xinitrc "$@"
else
	set -- "${XDG_CONFIG_HOME:-$HOME/.config}"/xinitrc "$@"
fi

exec </dev/null
cd ~

unset DBUS_SESSION_BUS_ADDRESS
unset SHLVL
export DISPLAY=$(next-display)
test "$DISPLAY" || die "could not find free display"
export XAUTHORITY=~/.Xauthority

# add Xauth

xauth remove "$HOSTNAME$DISPLAY"
xauth remove "$DISPLAY"
xauth add "$DISPLAY" MIT-MAGIC-COOKIE-1 $(mcookie) || exit

# start Xorg

echo "Starting Xorg on display $DISPLAY ($vt)"
xinit "$@" -- "$DISPLAY" "$vt" -noreset -auth "$XAUTHORITY" -quiet -background none
r=$?

# clean up

xauth remove "$DISPLAY"
exit $r
