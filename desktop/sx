#!/bin/sh

vt="vt$(fgconsole)" || {
	echo "Unable to determine current VT"
	exit 1
}

: ${XDG_CONFIG_HOME:=~/.config}
if [ -e "$XDG_CONFIG_HOME/xinitrc" ]; then
	xinitrc=$XDG_CONFIG_HOME/xinitrc
else
	xinitrc=~/.xinitrc
fi

export DISPLAY=$(next-display)
export XAUTHORITY=~/.Xauthority

cd ~
xauth remove "$HOSTNAME$DISPLAY"
xauth remove "$DISPLAY"
xauth add "$DISPLAY" MIT-MAGIC-COOKIE-1 $(mcookie)

echo "Starting Xorg on display $DISPLAY"
xinit "$xinitrc" "$@" -- "$DISPLAY" "$vt" \
	-noreset \
	-auth "$XAUTHORITY" \
	-quiet \
	-background none \
	< /dev/null; r=$?

xauth remove "$DISPLAY"
exit $r
