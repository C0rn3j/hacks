#!/bin/sh -e
# Simple sprunge.us pastebin client

seturl() {
	setfattr -n "user.sprunge-url" -v "$2" "$1" || :
} 2>/dev/null

post() {
	local url=$(curl -sF "sprunge=<$1" http://sprunge.us/)
	if [ "$url" ]; then
		seturl "$1" $url
		echo $url
	else
		echo "...failed"
	fi
}

if [ ! "$1" ] || [ "$1" == "-" ]; then
	# curl handles stdin buffering in a funny way, often
	# resulting in only the first write() to be pastebinned
	file=`mktemp /tmp/sprunge.XXXXXXXX`
	cat > "$file"
	if [ -s "$file" ]; then
		post "$file"
	else
		echo "stdin empty" >&2
	fi
	rm -f "$file"
else
	for file; do
		echo -n "$file â†’ "
		post "$file"
	done
fi
