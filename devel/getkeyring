#!/usr/bin/env python
import sys

import getopt
import gnomekeyring as gkr

def format(pattern, data):
	output = ""
	state = True
	for char in pattern:
		if state:
			if char is "%":
				state = False
			else:
				output += char
		else:
			if char in data:
				output += data[char]
			else:
				output += char
			state = True
	return output

def usage():
	print >> sys.stderr, "Usage: getkeyring [-k keyring] action [options]"
	print >> sys.stderr, """
Actions:
	list [-f format]
	get [-f format] <id>
"""
	sys.exit(2)

def is_keyring_locked():
#	return False
	info = gkr.get_info_sync(keyring)
	return info.get_is_locked()

def list_items(attrs=True):
	for id in sorted(gkr.list_item_ids_sync(keyring)):
		show_item(id, attrs)

def show_item(id, attrs=True):
	try:
		info = gkr.item_get_info_sync(keyring, id)
		data = gkr.item_get_attributes_sync(keyring, id)
	except gkr.BadArgumentsError:
		print >> sys.stderr, "getkeyring: Invalid arguments"
		return False

	if pretty:
		print "%d: %s" % (id, info.get_display_name())
		if attrs:
			for key in sorted(data.keys()):
				print "\t%s: %s" % (key, data[key])
	else:
		data["Name"] = info.get_display_name()
		data["Secret"] = info.get_secret()
		try:
			print format_pattern % data
		except KeyError as e:
			print >> sys.stderr, "getkeyring: item %d does not have key %s" % (id, e)
		except TypeError as e:
			print >> sys.stderr, "getkeyring: (item %d) %s" % (id, e)

if not gkr.is_available():
	print >> sys.stderr, "getkeyring: Keyring service not available"
	sys.exit(1)

keyring = gkr.get_default_keyring_sync()

pretty = True
format_pattern = None

opts, rest = getopt.gnu_getopt(sys.argv[1:], "f:k:")
for opt, value in opts:
	if opt == "-f":
		pretty = False
		format_pattern = value
	elif opt == "-k":
		keyring = value

try:
	command = rest.pop(0)
except IndexError:
	usage()

if is_keyring_locked():
	print >> sys.stderr, "getkeyring: keyring is locked"
	sys.exit(1)

if command == "list":
	list_items(False)
elif command == "show":
	if len(rest):
		for id in rest:
			show_item(int(id), True)
	else:
		list_items(True)
else:
	print >> sys.stderr, "getkeyring: Unknown command '%s'" % command
	sys.exit(2)
