# Opera Mini OBML file format

OBML (Opera Binary Markup Language) files are self-contained, rendered versions of HTML documents generated by the Presto v2 engine. They are static, containing pixel-positioned regions adapted for a specific device's screen size & font metrics. (Thus OBML documents generated for one device tend to look slightly 'off' everywhere else, and a perfect rendering is impossible without knowing the original device.)

Over time, various OBML versions were used, and each Opera Mini version is only compatible with one OBML format, thus an upgrade might leave old saved pages unreadable. (The OBML version used can be seen by visiting `debug:`.)

Most saved pages use OBML v12, v13, v15, or v16; I haven't investigated the format used by earlier "modded" Opera Mini versions which had this feature added unofficially.

## Basic data types

OBML uses these primitive types:

 * byte ‚Äì unsigned integer (1 byte)
 * short ‚Äì unsigned integer (2 bytes, big-endian)
 * medium ‚Äì unsigned integer (3 bytes, big-endian)
 * blob ‚Äì consists of a _short_ indicating the length, followed by that many bytes of data
 * char ‚Äì a _byte_ containing an ASCII character
 * string ‚Äì a _blob_ containing UTF-8 encoded text

## Other data types

### url ‚Üê string

Each OBML file has a "base URL", essentially a reusable prefix. When other URLs start with a null byte, it is to be replaced with the global prefix. For example, if the base is `http://example.com/dir` and you have an URL value `\x00/index.html`, it expands to `http://example.com/dir/index.html`.

### color ‚Üê (a: byte, r: byte, g: byte, b: byte)

Colors are stored as ARGB tuples, with one byte (0‚Äì255) per component.

### coords ‚Üê (x: short, y: medium)

Coordinates are stored as a _short_ for the X position (0‚Äì65535) followed by a _medium_ for the Y position (0‚Äì16777215). The origin (0, 0) is in the top-left corner.

In format versions ‚â§ 13, "position" coordinates are absolute and stored as-is.

In format version ‚â• 15, "position" coordinates are stored as _relative_ to the last position coordinate. Relative coordinates wrap around, thus negative offsets are stored as very large positive coordinates. For example, (-4, -2) is stored as (0xFFFC, 0xFFFFFE).

(Note that positions are relative only to the last position ‚Äì absolute coordinates like sizes do not affect the relative offset in any way.)

## Header

The file starts with a `file_size: medium` followed by `version: byte`.

For v‚â•15, *file_size* is always 0x02d355 and *version* is always 16; they're followed by a second identical header containing the real values. The reason for that is unknown.

Note that *file_size* only includes the bytes following it. It doesn't include the field's own size, nor the preceding fields.

Following is an unknown header (7 bytes for v16, 10 bytes for other versions).

Following are `page_title: string`, `unknown: blob`, `page_url_base: string`, and `page_url: url`. The unknown blob seems to always start with `C\x10\x10...` on v15, empty otherwise.

Following is an unknown header (6 bytes for v‚â•15, 5 bytes for v‚â§13).

Following is the "metadata" section and the "content" section, both composed of tagged chunks.

## Metadata section

This section consists of several chunks. Each chunk starts with `type: char` (an ASCII letter), followed by variable amount of fields.

### 'C' chunks

In v‚â•15, always contain `byte[23]` of unknown data.

### 'M' chunks

Always contain `byte[2]`, `blob` of unknown data. It seems the first byte is a sub-type. One subtype seems to contain a favicon as PNG, one contains an unknown blob of repeating `...\xff\x03\x00\x02\x00\x00...` junk.

### 'S' chunks

Appear to contain `links_size: medium` followed by a "links" sub-section of that size.

## Links sub-section

This section consists of chunks and appears to be a sub-section of the preceding 'S' chunk.

### '\x00' chunks

Always contain `unknown: byte` and `count: byte`, followed by that many `(id: string, label: string)` pairs. Each of these chunks seems to store the `<option>` choices for a HTML `<select>` widget.

### Region chunks

Most other chunks in this sub-section define 'regions' and share the same data format.

In v‚â•15 the format is `box_count: byte`, followed by that many `(pos: coords[rel], size: coords)` coordinate pairs, followed by `link_target: blob`, `unknown: byte[2]` (always `\x01\x74`), `link_type: blob`.

In v13 the format is `box_count: byte`, followed by that many `(pos: coords, size: coords)` coordinate pairs, followed by `link_target: blob`, `unknown: byte[2]`, `link_type: blob`.

In v12 the format is `box_count: byte`, followed by that many `(pos: coords, size: coords)` pairs, followed by `link_type: blob`, `link_target: blob`.

`link_type`, if non-empty, seems to be a _string_ with the MIME type.

`link_target` can be an _url_, a _string_, or an unknown blob.

### 'I', 'N', 'S', 'w', 'W' chunks

Unknown region types. These follow the "region chunk" format.

### 'C' chunks

In v‚â•15, an unknown region type. In v12, `unknown: byte[24]`; likely to also be a region type but I haven't checked yet.

### 'i' chunks

Image region (`link_target: url` links to the original image). Note that this doesn't actually render an image, only define a link region for the original URL. The image itself is drawn by the content section.

### 'L' chunks

Link region (`link_target: url` is the link target). Note that this isn't directly associated with link text in any way; it merely defines the 'active' rectangle overlayed on top of the text.

URLs starting with `b:` seem to be JavaScript links.

Note that v12 has a different format for 'L' chunks, different from the normal "region" format: `box_count: byte`, followed by `unknown: byte[2]`, followed by *box_count* √ó `(pos: coords, size: coords)` pairs, followed by `link_target: url`.

### 'P' chunks

Link region similar to 'L' but containing a "platform" link (usually `mailto:`).

## Content section

### 'B' chunks

Define a filled rectangle (a "box"); used to draw background colors, borders, other lines (including even link underlines).

In v‚â•15, contain `pos: coords[rel]`, `size: coords`, `fill: color`.

In v‚â§13, contain `pos: coords`, `size: coords`, `fill: color`.

### 'F' chunks

Unknown.

In v‚â•15, contain `byte[16]`, `blob`, `blob`, `byte[5]`.

In v‚â§13, contain `byte[16]`, `blob`, `blob`, `byte[3]`.

### 'I' chunks

Image.

In v16, contain `pos: coords[rel]`, `size: coords`, `unknown: byte[15]`.

In v15, contain `pos: coords[rel]`, `size: coords`, `unknown: byte[18]`.

In v‚â§13, contain `byte[20]` (not investigated yet).

### 'L' chunks

Unknown. Contain `byte[9]` with unknown data.

### 'M' chunks

Unknown. Contain `byte[2]`, `blob` with unknown data.

### 'o' chunks

Not sure if an actual chunk, or just part of the preceding 'I'-chunk.

Contain `blob` with unknown data.

### 'S' chunks

Embedded images.

Contain `data_size: medium`, followed by some number of `file_data: blob`. (The blob count isn't given, so keep reading blobs until you've consumed at least *data_size* bytes.)

Each ùíè-th blob contains an image (PNG or JPEG) to be drawn in the corresponding ùíè-th 'I' content chunk.

### 'T' chunks

Text.

In v16, contain `pos: coords[rel]`, `size: coords`, `foreground: color`, `unknown: byte`, `font: byte`, `unknown_count: byte`, *unknown_count* √ó `(byte, blob)` pairs, `text: string`. (It seems that the unknown pairs define some sort of links.)

In v15, contain `pos: coords[rel]`, `size: coords`, `foreground: color`, `font: byte`, `text: string`.

In v‚â§13, contain `pos: coords`, `size: coords`, `foreground: color`, `font: byte`, `text: string`.

In *font*, the least-significant bit indicates bold text. With the 'bold' bit masked out, the remaining bits indicate the font size:

  * `0` ‚Äì medium (approx. 11px)
  * `2` ‚Äì large (approx. 12px)
  * `4` ‚Äì extra large (approx. 13px)
  * `6` ‚Äì small (approx. 10px)

The following CSS results in an acceptable rendering:

    font-family: sans-serif;
    line-height: 1.1;
    white-space: pre;

## Miscellaneous notes

### Forms

Form buttons do not have special representation, they just consist of an image + text + link region, using special `b:‚Ä¶` URLs.

Input fields and select dropdowns haven't been fully researched yet.
