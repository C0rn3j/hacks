#!/usr/bin/env bash
service='host'
fqdn=$(hostname -f)
principal=
keytab=/etc/krb5.keytab
owner=
ccname=host

while getopts 'k:s:u:' OPT; do
	case $OPT in
	'k')	keytab=$OPTARG;;
	's')	service=$OPTARG;;
	'u')	owner=$OPTARG;;
	esac
done

[[ ! $principal ]] &&
	principal=$service/$fqdn

[[ $service != "host" ]] &&
	ccname="host_$service"

export KRB5CCNAME="/tmp/krb5cc_$ccname"

args=(	-k "$KRB5CCNAME"	# explicit ccache for `ps`
	-b -L -K 30		# daemonize, syslog, check every 30m
	-f "$keytab"		# credentials
	-u "$principal"		# principal
	-F -P			# not forwardable, not proxiable
	)

[[ $owner ]] && args+=( -o "$owner" )

exec k5start "${args[@]}"
