#!/usr/bin/env python2
# Copy ReplayGain tags from various formats to MP3 (for iPod downconversion;
# ffmpeg does not copy RVA2 automatically)

import sys
import mutagen

srcfile = sys.argv[1]
dstfile = sys.argv[2]

srctag = mutagen.File(srcfile)
dsttag = mutagen.mp3.MP3(dstfile)

if u'RVA2:track' in srctag:
# ID3v2.4 RVA2
	dsttag[u'RVA2:track'] = srctag[u'RVA2:track']
elif u'TXXX:replaygain_track_gain' in srctag:
# ID3v2 foobar2000
	rg_gain = float(srctag[u'TXXX:replaygain_track_gain'][0].split(' ')[0])
	rg_peak = float(srctag[u'TXXX:replaygain_track_peak'][0])
	dsttag[u'RVA2:track'] = mutagen.id3.RVA2(desc=u'track',
					channel=1,
					gain=rg_gain,
					peak=rg_peak)
elif 'replaygain_track_gain' in srctag:
# FLAC
	rg_gain = float(srctag['replaygain_track_gain'][0].split(' ')[0])
	rg_peak = float(srctag['replaygain_track_peak'][0])
	dsttag[u'RVA2:track'] = mutagen.id3.RVA2(desc=u'track',
					channel=1,
					gain=rg_gain,
					peak=rg_peak)
else:
# None
	print "No ReplayGain tag found."
	print srctag

dsttag.save()
