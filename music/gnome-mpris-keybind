#!/usr/bin/env perl
use warnings;
use strict;
use feature "say";
use Net::DBus;
use Net::DBus::Reactor;

sub usage {
	say for
	"Usage: gnome-mpris-keybind <playername>",
	"",
	"<playername> is the last component of the player's MPRISv2 D-Bus name; for",
	"example, \"mpd\" for \"org.mpris.MediaPlayer2.mpd\".",
	;
	exit 2;
}

my $player = shift(@ARGV) // usage();

if ($player =~ /^-/) {
	usage();
} elsif ($player =~ /^org\.mpris\.MediaPlayer2\.(.+)$/) {
	$player = $1;
} elsif ($player =~ /^org\.mpris\./) {
	warn "error: MPRIS v1 interface is not supported\n";
	exit(1);
}

my $appname = "gnome-mpris-keybind ($player)";

my $bus		= Net::DBus->session;
my $mp_svc	= $bus->get_service("org.mpris.MediaPlayer2.$player");
my $mp_player	= $mp->get_object("/org/mpris/MediaPlayer2");
my $gsd_svc	= $bus->get_service("org.gnome.SettingsDaemon");
my $gsd_mmkeys	= $gsd->get_object("/org/gnome/SettingsDaemon/MediaKeys");

$gsd_mmkeys->connect_to_signal("MediaPlayerKeyPressed", sub {
	my ($app, $key) = @_;
	given ($key) {
		when ("Play") {
			$mp_player->PlayPause();
		}
		when ("Stop") {
			$mp_player->Stop();
		}
		when ("Next") {
			$mp_player->Next();
		}
		when ("Previous") {
			$mp_player->Previous();
		}
	}
});

$gsd_mmkeys->GrabMediaPlayerKeys($appname, 0);

my $reactor = Net::DBus::Reactor->main;
$reactor->run;
exit(0);
