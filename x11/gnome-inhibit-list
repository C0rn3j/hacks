#!/usr/bin/env perl
# gnome-inhibit-list - list power saving inhibitors in GNOME
#
# Â© 2012 Mantas M. <grawity@gmail.com>
# Released under WTFPL v2 <http://sam.zoy.org/wtfpl/>
use v5.10;
use warnings;
use strict;
use locale;

use List::Util qw(max);
use Net::DBus;

my %FLAGS = (
	"logout"	=> 1<<0,
	"switch-user"	=> 1<<1,
	"suspend"	=> 1<<2,
	"idle"		=> 1<<3,
	"automount"	=> 1<<4,
);

sub usage {
	say for
	"Usage: gnome-inhibit-list",
	"",
	"Shows all inhibitors kept by GNOME Session Manager.",
	;
	exit(0);
}

sub maxlength {
	my ($attr, @items) = @_;
	(max map {length $_->{$attr}} @items) // 0;
}

sub flags2arr {
	my ($bits) = @_;
	$bits ? sort grep {$bits & $FLAGS{$_}} keys %FLAGS : "none";
}

usage if @ARGV;

my $bus	= Net::DBus->session;
my $sms	= $bus->get_service("org.gnome.SessionManager");
my $sm	= $sms->get_object("/org/gnome/SessionManager");

my @inhibitors =
	sort {$a->{app_id} cmp $b->{app_id}}
	map {
		my $ih_path = $_;
		my $ih = $sms->get_object($ih_path);
		my $v = {
			path      => $ih_path,
			app_id    => $ih->GetAppId,
			client_id => eval {$ih->GetClientId} // "(none)",
			flags     => $ih->GetFlags,
			reason    => eval {$ih->GetReason} // "(none)",
			xid       => $ih->GetToplevelXid,
		};
		$v->{szflags} = join(",", flags2arr($v->{flags}));
		$v;
	}
	@{$sm->GetInhibitors};

my $len_app_id = max(11, maxlength app_id => @inhibitors);
my $len_reason = max(6,  maxlength reason => @inhibitors);
my $len_flags  = max(8,  maxlength szflags => @inhibitors);

printf "%-*s  %-*s  %-*s\n",
	$len_app_id,	"APPLICATION",
	$len_reason,	"REASON",
	$len_flags,	"INHIBITS";

for my $v (@inhibitors) {
	printf "%-*s  %-*s  %-*s\n",
		$len_app_id,	$v->{app_id},
		$len_reason,	$v->{reason},
		$len_flags,	$v->{szflags};
}
