#!/usr/bin/env bash

. lib.bash || exit

session=${DESKTOP_SESSION:-default}

if [[ $session == default ]]; then
	if [[ $GNOME_DESKTOP_SESSION_ID ]]; then
		session=gnome
	elif [[ $DBUS_SESSION_BUS_ADDRESS ]]; then
		if dbus-name -q org.gnome.SessionManager; then
			session=gnome
		elif dbus-name -q org.xfce.SessionManager; then
			session=xfce
		fi
	fi
fi

case $session in
    enlightenment)
	name=Enlightenment
	cmd='enlightenment_remote -exit'
	;;
    gnome|gnome-*)
	name=GNOME
	if have gnome-session-quit; then
		cmd='gnome-session-quit --logout --force --no-prompt'
	elif have gnome-session-save; then
		cmd='gnome-session-save --force-logout --silent'
	fi
	;;
    herbstluftwm)
	name=Herbstluftwm
	cmd='herbstclient quit'
	;;
    kde-plasma|kde-plasma-safe)
	name=KDE
	cmd='qdbus org.kde.ksmserver /KSMServer logout 0 -1 -1'
	;;
    [Oo]penbox)
	name=Openbox
	cmd='openbox --exit'
	;;
    ubuntu)
	name=Unity
	cmd='gnome-session-quit --logout --force --no-prompt'
	;;
    Windows_NT)
	name=Windows
	cmd='logoff.exe'
	;;
    wmii)
	name=Wmii
	cmd='wmiir xwrite /ctl quit'
	;;
    xfce)
	name=Xfce4
	cmd='xfce4-session-logout --logout'
	;;
    *)
	die "unknown desktop environment"
esac

debug "detected: $name"
debug "will use: $cmd"

if [[ $DEBUG ]]; then
	echo "Doing nothing in debug mode."
else
	echo "Logging out of ${name}..."
	eval "$cmd"
fi
