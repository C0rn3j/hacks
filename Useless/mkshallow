#!/usr/bin/env bash
set -e

url='git://nullroute.eu.org/trash.git'
ref='refs/tmp/shallow-test'
tmpdir='/tmp/shallow.git'

rm -rf "$tmpdir"
git init --quiet --bare "$tmpdir"
cd "$tmpdir"

git remote add origin "$url"
git config remote.origin.fetch "$ref:$ref"
git fetch --quiet --depth=1 origin
git symbolic-ref HEAD "$ref"
parent=$(git rev-parse "$ref")

blob=$(echo "This is a test at $(date)" | git mkobject)
[[ $blob ]]

tree=$(printf '%s %s %s\t%s\n' 100644 blob $blob test.txt | git mktree)
[[ $tree ]]

commit=$(echo "Test commit" | git commit-tree -p $parent $tree)
[[ $commit ]]

git push --quiet "$url" "$commit:$ref"

echo "$commit $ref"

#cd /
